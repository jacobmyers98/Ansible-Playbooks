---
# ansible-playbook Playbooks/simple_update.yml
- hosts: all
  become: true
  tasks:
  - name: apt update
    apt:
      upgrade: yes
      update_chache: yes

  - name: check the mount of servers
    ansible.builtin.stat:
      path: /mnt/media
    register: mount

  - name: Mounting network drives
    shell: mkdir /mnt/Media                                                       #Variable, could reference variable file if needed
    shell: mount -t cifs //192.168.0.10/Media /mnt/Media -o username=server       #Variable, could reference variable file if needed
    when: mount.stat.exists == False

  - name: check pterodactyl is installed
    ansible.builtin.stat:
      path: /var/www/pterodactyl
    register: p_alive

  - name: update pterodactyl if alive
    command: cd /var/www/pterodactyl
    command: php artisan down
    command: curl -L https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz | tar -xzv
    command: chmod -R 755 storage/* bootstrap/cache
    command: composer install --no-dev --optimize-autoloader
    command: php artisan view:clear
    command: php artisan config:clear
    command: php artisan migrate --seed --force
    command: chown -R www-data:www-data /var/www/pterodactyl/*
    command: php artisan queue:restart
    command: php artisan up
    command: systemctl stop wings
    command: curl -L -o /usr/local/bin/wings "https://github.com/pterodactyl/wings/releases/latest/download/wings_linux_$([[ "$(uname -m)" == "x86_64" ]] && echo "amd64" || echo "arm64")"
    command: chmod u+x /usr/local/bin/wings
    command: systemctl restart wings   
    when: p_alive.stat.exists

  - name: check docker-compose is installed
    ansible.builtin.stat:
      path: /home/torrent/docker_torrents
    register: docker_alive

  - name: update docker-compose if alive
    command: cd /home/torrent/docker_torrents
    command: docker-compose up -d
    when: docker_alive.stat.exists
